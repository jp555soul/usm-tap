<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#000000"/>
  <title>CubeAI Map</title>
  <link href="static/css/main.c4e4820c.css" rel="stylesheet">
  
  <script>
    console.log('[HTML] Loading map_bridge.html');
    window.flutterBridgeReady = false;
    window.flutterBridgeQueue = [];
    window.flutterBridge = {
      sendToFlutter: function(type, data) {
        const message = JSON.stringify({ type, data });
        if (!window.flutterBridgeReady) {
          console.log('[Bridge] Queuing:', type);
          window.flutterBridgeQueue.push(message);
          return;
        }
        if (window.FlutterBridge && window.FlutterBridge.postMessage) {
          try {
            window.FlutterBridge.postMessage(message);
            console.log('[Bridge] Sent:', type);
          } catch (e) { console.error('[Bridge] Error:', e); }
        }
      },
      receiveFromFlutter: function(message) {
        try {
          const { type, data } = JSON.parse(message);
          console.log('[Flutter -> Bridge]', type);
          if (type === 'UPDATE_PROPS' && window.updateMapProps) window.updateMapProps(data);
          else if (type === 'UPDATE_FRAME' && window.updateFrame) window.updateFrame(data.currentFrame);
          else if (type === 'UPDATE_DEPTH' && window.updateDepth) window.updateDepth(data.selectedDepth);
          else if (type === 'UPDATE_LAYER_VISIBILITY' && window.updateLayerVisibility) window.updateLayerVisibility(data);
        } catch (e) { console.error('[Bridge] Receive error:', e); }
      }
    };
    setTimeout(function checkBridge() {
      if (window.FlutterBridge && window.FlutterBridge.postMessage) {
        console.log('[Bridge] Ready! Flushing', window.flutterBridgeQueue.length, 'messages');
        window.flutterBridgeReady = true;
        window.flutterBridgeQueue.forEach(function(msg) {
          try { window.FlutterBridge.postMessage(msg); }
          catch (e) { console.error('[Bridge] Queue error:', e); }
        });
        window.flutterBridgeQueue = [];
      } else { setTimeout(checkBridge, 50); }
    }, 50);
    window.addEventListener('error', function(e) { console.error('[Global Error]', e.error); });
    window.addEventListener('load', function() {
      console.log('[HTML] Window loaded');
      window.flutterBridge.sendToFlutter('MAP_READY', { timestamp: new Date().toISOString() });
    });
  </script>
</head>
<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div id="root"></div>
  <script>console.log('[HTML] Loading React bundle...');</script>
  <script src="static/js/main.49962564.js"></script>
  <script>console.log('[HTML] React bundle loaded');</script>
</body>
</html>
